import { useEffect, useState } from "react";
import { invoke } from "@tauri-apps/api/core";
import { open, save } from "@tauri-apps/plugin-dialog";
import Editor from "@monaco-editor/react";
import "./App.css";

function registerLatexLanguage(monaco) {
    monaco.languages.register({ id: "latex" });
    monaco.languages.setMonarchTokensProvider("latex", {
        tokenizer: {
            root: [
                [/%.*$/, "comment"],
                [/\\[a-zA-Z@]+/, "keyword"],
                [/\{|\}/, "delimiter.bracket"],
                [/\$+/, "delimiter"],
                [/\\begin(?=\{)/, "keyword"],
                [/\\end(?=\{)/, "keyword"]
            ]
        }
    });
    monaco.languages.setLanguageConfiguration("latex", {
        comments: { lineComment: "%" },
        brackets: [
            ["{", "}"],
            ["[", "]"],
            ["(", ")"]
        ],
        autoClosingPairs: [
            { open: "{", close: "}" },
            { open: "[", close: "]" },
            { open: "(", close: ")" },
            { open: "$", close: "$" }
        ],
        surroundingPairs: [
            { open: "{", close: "}" },
            { open: "[", close: "]" },
            { open: "(", close: ")" },
            { open: "$", close: "$" }
        ]
    });
}

function App() {
    // 默认的 LaTeX 模版代码
    const [code, setCode] = useState(
        `\\documentclass{article}
\\usepackage{amsmath}
\\begin{document}
\\title{Hello Tauri + Tectonic}
\\author{Your Name}
\\maketitle

\\section{Introduction}
This is a \\textbf{PDF} generated by Tectonic via CLI!

\\section{Formula}
Einstein said:
$$ E = mc^2 $$

\\end{document}`
    );

    const [pdfUrl, setPdfUrl] = useState("");
    const [currentPath, setCurrentPath] = useState("");
    const [loading, setLoading] = useState(false);
    const [logs, setLogs] = useState("");

    async function handleCompile() {
        setLoading(true);
        setLogs("Compiling... (Check terminal for details)");
        try {
            // 调用我们在 Rust 后端写的 compile_latex 命令
            const pdfBytes = await invoke("compile_latex", { latexCode: code });

            // 将返回的二进制数据转换为可以在浏览器显示的 URL
            const byteArray = new Uint8Array(pdfBytes);
            const blob = new Blob([byteArray], { type: "application/pdf" });
            const url = URL.createObjectURL(blob);

            setPdfUrl(url);
            setLogs("Success! PDF generated.");
        } catch (e) {
            console.error(e);
            setLogs("Error: " + e);
            alert("编译出错: " + e);
        } finally {
            setLoading(false);
        }
    }

    async function handleSaveAs() {
        const path = await save({
            filters: [{ name: "LaTeX", extensions: ["tex"] }]
        });

        if (!path) {
            setLogs("Save canceled.");
            return;
        }

        setLogs("Saving...");
        try {
            await invoke("save_file", { path, content: code });
            setCurrentPath(path);
            setLogs(`Saved: ${path}`);
        } catch (e) {
            console.error(e);
            setLogs("Save failed: " + e);
            alert("保存出错: " + e);
        }
    }

    async function handleSave() {
        if (!currentPath) {
            await handleSaveAs();
            return;
        }

        setLogs("Saving...");
        try {
            await invoke("save_file", { path: currentPath, content: code });
            setLogs(`Saved: ${currentPath}`);
        } catch (e) {
            console.error(e);
            setLogs("Save failed: " + e);
            alert("保存出错: " + e);
        }
    }

    async function handleOpen() {
        const selected = await open({
            filters: [{ name: "LaTeX", extensions: ["tex"] }],
            multiple: false
        });

        if (!selected) {
            setLogs("Open canceled.");
            return;
        }

        const path = Array.isArray(selected) ? selected[0] : selected;
        setLogs("Opening...");
        try {
            const content = await invoke("read_file", { path });
            setCode(content);
            setCurrentPath(path);
            setLogs(`Opened: ${path}`);
        } catch (e) {
            console.error(e);
            setLogs("Open failed: " + e);
            alert("打开出错: " + e);
        }
    }

    useEffect(() => {
        const isMac = navigator.platform.toUpperCase().includes("MAC");
        const handleKeydown = (event) => {
            const isSaveCombo = (isMac ? event.metaKey : event.ctrlKey) && event.key.toLowerCase() === "s";
            if (!isSaveCombo) {
                return;
            }
            event.preventDefault();
            handleSave();
        };

        window.addEventListener("keydown", handleKeydown);
        return () => window.removeEventListener("keydown", handleKeydown);
    }, [code, currentPath]);

    return (
        <div style={{ display: "flex", height: "100vh", flexDirection: "column", fontFamily: "sans-serif" }}>
            {/* 顶部工具栏 */}
            <div style={{ padding: "10px", background: "#f0f0f0", borderBottom: "1px solid #ccc", display: "flex", alignItems: "center", gap: "10px" }}>
                <button
                    onClick={handleCompile}
                    disabled={loading}
                    style={{ padding: "8px 16px", cursor: loading ? "not-allowed" : "pointer", backgroundColor: "#007acc", color: "white", border: "none", borderRadius: "4px" }}
                >
                    {loading ? "Compiling..." : "▶ Run Compile"}
                </button>
                <button
                    onClick={handleOpen}
                    style={{ padding: "8px 16px", cursor: "pointer", backgroundColor: "#6b6b6b", color: "white", border: "none", borderRadius: "4px" }}
                >
                    Open
                </button>
                <button
                    onClick={handleSave}
                    style={{ padding: "8px 16px", cursor: "pointer", backgroundColor: "#1f6feb", color: "white", border: "none", borderRadius: "4px" }}
                >
                    Save
                </button>
                <button
                    onClick={handleSaveAs}
                    style={{ padding: "8px 16px", cursor: "pointer", backgroundColor: "#2d8f5a", color: "white", border: "none", borderRadius: "4px" }}
                >
                    Save As
                </button>
                <span style={{ fontSize: "12px", color: loading ? "blue" : "#333" }}>{logs}</span>
            </div>

            {/* 主体区域 */}
            <div style={{ display: "flex", flex: 1, overflow: "hidden" }}>
                {/* 左侧：编辑器 */}
                <div style={{ width: "50%", borderRight: "1px solid #ddd" }}>
                    <Editor
                        height="100%"
                        language="latex"
                        theme="vs-dark"
                        value={code}
                        onChange={(value) => setCode(value || "")}
                        beforeMount={registerLatexLanguage}
                        options={{
                            minimap: { enabled: false },
                            fontSize: 14,
                            wordWrap: "on"
                        }}
                    />
                </div>

                {/* 右侧：预览 */}
                <div style={{ width: "50%", background: "#555", display: "flex", alignItems: "center", justifyContent: "center" }}>
                    {pdfUrl ? (
                        <iframe
                            src={pdfUrl}
                            width="100%"
                            height="100%"
                            style={{ border: "none" }}
                            title="PDF Preview"
                        />
                    ) : (
                        <div style={{ color: "#ccc" }}>Click "Run Compile" to generate PDF</div>
                    )}
                </div>
            </div>
        </div>
    );
}

export default App;
